<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>채팅 & 친구 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
          background: url('/img/background.jpg') no-repeat center center fixed;
          background-size: cover;
          font-family: 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
          margin: 0;
          padding: 0;
        }
        .container {
          margin-top: 50px;
          background-color: rgba(255, 255, 255, 0.95);
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .chat-log {
          height: 300px;
          overflow-y: auto;
          border-radius: 8px;
          background: #f1f3f5;
          padding: 10px;
          margin-bottom: 10px;
        }
        .chat-room-list, .friend-list {
          max-height: 200px;
          overflow-y: auto;
        }
        .btn-create-room {
          width: 100%;
        }
    </style>
</head>
<body>
<div class="container">
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#chat">실시간 채팅</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#friend">친구 관리</button>
        </li>
    </ul>

    <div class="tab-content mt-3">
        <!-- 실시간 채팅 -->
        <div class="tab-pane fade show active" id="chat">
            <div class="row">
                <div class="col-md-8">
                    <h5>채팅창</h5>
                    <div class="chat-log" id="chat-log"></div>
                    <div class="d-flex">
                        <input type="text" class="form-control me-2" id="chat-input" placeholder="메시지 입력">
                        <button class="btn btn-primary">전송</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6>내 채팅방 목록</h6>
                    <input type="text" class="form-control mb-2" placeholder="채팅방 검색">
                    <div class="chat-room-list border rounded p-2 mb-2" id="chat-room-list"></div>
                    <button class="btn btn-warning btn-create-room" data-bs-toggle="modal" data-bs-target="#createRoomModal">➕ 채팅방 생성</button>
                </div>
            </div>
        </div>

        <!-- 친구 관리 -->
        <div class="tab-pane fade" id="friend">
            <div class="row">
                <div class="col-md-6">
                    <h6>🔍 친구 검색 및 요청</h6>
                    <input type="text" id="search-name" class="form-control mb-2" placeholder="친구 이름 입력">
                    <button class="btn btn-outline-primary" onclick="sendFriendRequest()">친구 요청</button>
                </div>
                <div class="col-md-6">
                    <h6>📩 친구 요청 알림</h6>
                    <div class="border rounded p-2" id="friend-request-list" style="height: 150px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="mt-3">
                <h6>👥 나의 친구 목록</h6>
                <input type="text" id="search-friend" class="form-control mb-2" placeholder="친구 검색" oninput="searchFriend()">
                <div class="friend-list border rounded p-2" id="friend-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- 채팅방 생성 모달 -->
<div class="modal fade" id="createRoomModal" tabindex="-1" aria-labelledby="createRoomModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">채팅방 생성</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control mb-2" placeholder="채팅방 이름">
                <input type="text" class="form-control" placeholder="참여자 이름 (쉼표로 구분)">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary">생성</button>
            </div>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem("token");

    function sendFriendRequest() {
      const accepter = document.getElementById('search-name').value;
      fetch(`/api/v1/friend/request?accepter=${accepter}`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => alert("친구 요청 완료: " + data.description.message));
    }

    function loadFriendRequests() {
      fetch(`/api/v1/friend/request/receivedlist`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        const listDiv = document.getElementById("friend-request-list");
        listDiv.innerHTML = "";
        data.receivedFriendList.forEach(item => {
          const container = document.createElement("div");
          container.className = "d-flex justify-content-between align-items-center mb-2";
          container.innerHTML = `
            <span>${item.requesterName}</span>
            <div>
              <button class="btn btn-sm btn-success me-1" onclick="handleFriendAction(${item.requestId}, 'ACCEPTED')">수락</button>
              <button class="btn btn-sm btn-danger" onclick="handleFriendAction(${item.requestId}, 'REJECTED')">거절</button>
            </div>
          `;
          listDiv.appendChild(container);
        });
      });
    }

    function handleFriendAction(id, status) {
      fetch(`/api/v1/friend/request/receivedlist/handle?requestId=${id}&status=${status}`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(() => {
        alert("처리 완료");
        loadFriendRequests();
        loadMyFriendList();
      });
    }

    function loadMyFriendList() {
      fetch("/api/v1/friend/list", {
        headers: { Authorization: `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("friend-list");
        container.innerHTML = "";
        data.receivedFriendList.forEach(item => {
          const div = document.createElement("div");
          div.className = "d-flex justify-content-between align-items-center mb-2";
          div.innerHTML = `
            <span>${item.requesterName}</span>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteFriend(${item.requestId})">삭제</button>
          `;
          container.appendChild(div);
        });
      });
    }

    function deleteFriend(id) {
      fetch(`/api/v1/friend/list/delete?requestId=${id}`, {
        method: "DELETE",
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(() => {
        alert("삭제 완료");
        loadMyFriendList();
      });
    }

    function searchFriend() {
      const keyword = document.getElementById("search-friend").value;
      fetch(`/api/v1/friend/list/search?keyword=${keyword}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        const friendList = document.getElementById("friend-list");
        friendList.innerHTML = "";
        data.receivedFriendList.forEach(f => {
          const div = document.createElement("div");
          div.className = "d-flex justify-content-between align-items-center mb-2";
          div.innerHTML = `
            <span>${f.requesterName}</span>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteFriend(${f.requestId})">삭제</button>
          `;
          friendList.appendChild(div);
        });
      });
    }

    window.onload = () => {
      loadFriendRequests();
      loadMyFriendList();
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
