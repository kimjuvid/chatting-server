<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ì±„íŒ… & ì¹œêµ¬ ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
          background: url('/img/background.jpg') no-repeat center center fixed;
          background-size: cover;
          font-family: 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
          margin: 0;
          padding: 0;
        }
        .container {
          margin-top: 50px;
          background-color: rgba(255, 255, 255, 0.95);
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .chat-log {
          height: 300px;
          overflow-y: auto;
          border-radius: 8px;
          background: #f1f3f5;
          padding: 10px;
          margin-bottom: 10px;
        }
        .chat-room-list, .friend-list {
          max-height: 200px;
          overflow-y: auto;
        }
        .btn-create-room {
          width: 100%;
        }
    </style>
</head>
<body>
<div class="container">
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#chat">ì‹¤ì‹œê°„ ì±„íŒ…</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#friend">ì¹œêµ¬ ê´€ë¦¬</button>
        </li>
    </ul>

    <div class="tab-content mt-3">
        <!-- ì‹¤ì‹œê°„ ì±„íŒ… -->
        <div class="tab-pane fade show active" id="chat">
            <div class="row">
                <div class="col-md-8">
                    <h5>ì±„íŒ…ì°½</h5>
                    <div class="chat-log" id="chat-log"></div>
                    <div class="d-flex">
                        <input type="text" class="form-control me-2" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥">
                        <button class="btn btn-primary">ì „ì†¡</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6>ë‚´ ì±„íŒ…ë°© ëª©ë¡</h6>
                    <input type="text" class="form-control mb-2" placeholder="ì±„íŒ…ë°© ê²€ìƒ‰">
                    <div class="chat-room-list border rounded p-2 mb-2" id="chat-room-list"></div>
                    <button class="btn btn-warning btn-create-room" data-bs-toggle="modal" data-bs-target="#createRoomModal">â• ì±„íŒ…ë°© ìƒì„±</button>
                </div>
            </div>
        </div>

        <!-- ì¹œêµ¬ ê´€ë¦¬ -->
        <div class="tab-pane fade" id="friend">
            <div class="row">
                <div class="col-md-6">
                    <h6>ğŸ” ì¹œêµ¬ ê²€ìƒ‰ ë° ìš”ì²­</h6>
                    <input type="text" id="search-name" class="form-control mb-2" placeholder="ì¹œêµ¬ ì´ë¦„ ì…ë ¥">
                    <button class="btn btn-outline-primary" onclick="sendFriendRequest()">ì¹œêµ¬ ìš”ì²­</button>
                </div>
                <div class="col-md-6">
                    <h6>ğŸ“© ì¹œêµ¬ ìš”ì²­ ì•Œë¦¼</h6>
                    <div class="border rounded p-2" id="friend-request-list" style="height: 150px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="mt-3">
                <h6>ğŸ‘¥ ë‚˜ì˜ ì¹œêµ¬ ëª©ë¡</h6>
                <input type="text" id="search-friend" class="form-control mb-2" placeholder="ì¹œêµ¬ ê²€ìƒ‰" oninput="searchFriend()">
                <div class="friend-list border rounded p-2" id="friend-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ -->
<div class="modal fade" id="createRoomModal" tabindex="-1" aria-labelledby="createRoomModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì±„íŒ…ë°© ìƒì„±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control mb-2" placeholder="ì±„íŒ…ë°© ì´ë¦„">
                <input type="text" class="form-control" placeholder="ì°¸ì—¬ì ì´ë¦„ (ì‰¼í‘œë¡œ êµ¬ë¶„)">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary">ìƒì„±</button>
            </div>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem("token");

    function sendFriendRequest() {
      const accepter = document.getElementById('search-name').value;
      fetch(`/api/v1/friend/request?accepter=${accepter}`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => alert("ì¹œêµ¬ ìš”ì²­ ì™„ë£Œ: " + data.description.message));
    }

    function loadFriendRequests() {
      fetch(`/api/v1/friend/request/receivedlist`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        const listDiv = document.getElementById("friend-request-list");
        listDiv.innerHTML = "";
        data.receivedFriendList.forEach(item => {
          const container = document.createElement("div");
          container.className = "d-flex justify-content-between align-items-center mb-2";
          container.innerHTML = `
            <span>${item.requesterName}</span>
            <div>
              <button class="btn btn-sm btn-success me-1" onclick="handleFriendAction(${item.requestId}, 'ACCEPTED')">ìˆ˜ë½</button>
              <button class="btn btn-sm btn-danger" onclick="handleFriendAction(${item.requestId}, 'REJECTED')">ê±°ì ˆ</button>
            </div>
          `;
          listDiv.appendChild(container);
        });
      });
    }

    function handleFriendAction(id, status) {
      fetch(`/api/v1/friend/request/receivedlist/handle?requestId=${id}&status=${status}`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(() => {
        alert("ì²˜ë¦¬ ì™„ë£Œ");
        loadFriendRequests();
        loadMyFriendList();
      });
    }

    function loadMyFriendList() {
      fetch("/api/v1/friend/list", {
        headers: { Authorization: `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("friend-list");
        container.innerHTML = "";
        data.receivedFriendList.forEach(item => {
          const div = document.createElement("div");
          div.className = "d-flex justify-content-between align-items-center mb-2";
          div.innerHTML = `
            <span>${item.requesterName}</span>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteFriend(${item.requestId})">ì‚­ì œ</button>
          `;
          container.appendChild(div);
        });
      });
    }

    function deleteFriend(id) {
      fetch(`/api/v1/friend/list/delete?requestId=${id}`, {
        method: "DELETE",
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(() => {
        alert("ì‚­ì œ ì™„ë£Œ");
        loadMyFriendList();
      });
    }

    function searchFriend() {
      const keyword = document.getElementById("search-friend").value;
      fetch(`/api/v1/friend/list/search?keyword=${keyword}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        const friendList = document.getElementById("friend-list");
        friendList.innerHTML = "";
        data.receivedFriendList.forEach(f => {
          const div = document.createElement("div");
          div.className = "d-flex justify-content-between align-items-center mb-2";
          div.innerHTML = `
            <span>${f.requesterName}</span>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteFriend(${f.requestId})">ì‚­ì œ</button>
          `;
          friendList.appendChild(div);
        });
      });
    }

    window.onload = () => {
      loadFriendRequests();
      loadMyFriendList();
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
