<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>실시간 채팅</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
          background: url('/img/background.jpg') no-repeat center center fixed;
          background-size: contain;
          background-color: #c7ccc0;
          font-family: 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
          height: 100vh;
          margin: 0;
          padding: 0;
        }

        .chat-container {
          width: 90%;                /* 💡 뷰포트에 맞춰 유동적으로 너비 조절 */
          max-width: 800px;          /* 💡 데스크탑 최대 너비 제한 */
          min-width: 320px;          /* 💡 너무 작아지는 것도 방지 */
          margin: 60px auto;
          background: white;
          border-radius: 15px;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
          padding: 25px;
        }

        .chat-box {
          height: 400px;
          overflow-y: auto;
          padding: 10px;
          background-color: #f8f9fa;
          border-radius: 10px;
          margin-bottom: 15px;
        }

        .btn-send {
          background: linear-gradient(90deg, #feda75, #fa7e1e, #d62976);
          color: white;
          font-weight: bold;
          border: none;
          border-radius: 10px;
          padding: 10px;
          transition: background 0.3s ease-in-out;
        }

        .btn-send:hover {
          background: linear-gradient(90deg, #fa7e1e, #d62976);
        }

        .message {
          margin-bottom: 12px;
          display: flex;
          flex-direction: column;
        }

        .from-me {
          align-items: flex-end;
        }

        .from-me .bubble {
          background-color: #fee500;
          color: #333;
          border-radius: 10px 0 10px 10px;
        }

        .from-you {
          align-items: flex-start;
        }

        .from-you .bubble {
          background-color: #e4e6eb;
          color: #111;
          border-radius: 0 10px 10px 10px;
        }

        .bubble {
          padding: 10px 14px;
          max-width: 70%;
          word-wrap: break-word;
          font-size: 0.95rem;
        }

        .chat-input {
          display: flex;
          gap: 10px;
        }

        .chat-input input {
          flex-grow: 1;
        }

        .username {
          font-size: 0.8rem;
          color: #888;
          margin-bottom: 3px;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <h4 class="text-center mb-4">💬 실시간 채팅</h4>

    <div class="mb-2">
        <label class="form-label">받는 사람</label>
        <input type="text" class="form-control" id="to" placeholder="상대방 이름" oninput="searchUser()" onchange="loadChatLog()" />
        <div id="to-suggestions"></div>
    </div>

    <div class="chat-box" id="log"></div>

    <div class="chat-input">
        <input type="text" id="message" class="form-control" placeholder="메시지 입력" />
        <button class="btn btn-send" onclick="sendMessage()">전송</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

<script>
    let stompClient = null;
    const username = localStorage.getItem("username");
    const token = localStorage.getItem("token");

    if (!username || !token) {
      alert("로그인이 필요합니다.");
      window.location.href = "/login.html";
    }

    window.onload = () => {
      connectWebSocket();
    };

    function connectWebSocket() {
      const socket = new SockJS("/ws-stomp");
      stompClient = Stomp.over(socket);
      stompClient.connect({}, () => {
        stompClient.subscribe("/sub/chat", (msg) => {
          const payload = JSON.parse(msg.body);
          appendMessage(payload.from, payload.message);
        });
      });
    }

    function sendMessage() {
      const to = document.getElementById("to").value;
      const message = document.getElementById("message").value;
      if (!message || !to) return;

      stompClient.send(`/pub/chat/message/${username}`, {}, JSON.stringify({ from: username, to, message }));
      document.getElementById("message").value = "";
    }

    function appendMessage(from, message) {
      const log = document.getElementById("log");
      const isMe = from === username;

      const wrapper = document.createElement("div");
      wrapper.className = `message ${isMe ? "from-me" : "from-you"}`;

      const sender = document.createElement("div");
      sender.className = "username";
      sender.textContent = isMe ? "나" : from;

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = message;

      wrapper.appendChild(sender);
      wrapper.appendChild(bubble);
      log.appendChild(wrapper);
      log.scrollTop = log.scrollHeight;
    }

    function loadChatLog() {
      const to = document.getElementById("to").value;
      fetch(`/api/v1/chat/chat-list?name=${username}&to=${to}`, {
        method: "GET",
        headers: { Authorization: `Bearer ${token}` },
      })
        .then((res) => res.json())
        .then((messages) => {
          const log = document.getElementById("log");
          log.innerHTML = "";
          messages.forEach((m) => {
            appendMessage(m.from, m.message);
          });
        });
    }

    function searchUser() {
      const input = document.getElementById("to").value;
      const suggestions = document.getElementById("to-suggestions");

      if (!input) return;

      fetch(`/api/v1/user/search/${input}`, {
        headers: { Authorization: `Bearer ${token}` },
      })
        .then((res) => res.json())
        .then((names) => {
          suggestions.innerHTML = "";
          names.name.forEach((name) => {
            const div = document.createElement("div");
            div.textContent = name;
            div.style.cursor = "pointer";
            div.onclick = () => {
              document.getElementById("to").value = name;
              suggestions.innerHTML = "";
              loadChatLog();
            };
            suggestions.appendChild(div);
          });
        });
    }
</script>
</body>
</html>
