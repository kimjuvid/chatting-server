<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ì±„íŒ… & ì¹œêµ¬ ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
          background: url('/img/background.jpg') no-repeat center center fixed;
          background-size: cover;
          font-family: 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
          margin: 0;
          padding: 0;
        }
        .container {
          margin-top: 50px;
          background-color: rgba(255, 255, 255, 0.95);
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .chat-log {
          height: 300px;
          overflow-y: auto;
          border-radius: 8px;
          background: #f1f3f5;
          padding: 10px;
          margin-bottom: 10px;
        }
        .chat-room-list, .friend-list {
          max-height: 200px;
          overflow-y: auto;
        }
        .btn-create-room {
          width: 100%;
        }
        .selected-users {
          background: #f8f9fa;
          border-radius: 8px;
          padding: 10px;
          margin-top: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#chat">ì‹¤ì‹œê°„ ì±„íŒ…</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#friend">ì¹œêµ¬ ê´€ë¦¬</button>
        </li>
    </ul>

    <div class="tab-content mt-3">
        <div class="tab-pane fade show active" id="chat">
            <div class="row">
                <div class="col-md-8">
                    <h4>ğŸ’¬ ì±„íŒ…ì°½</h4>
                    <div id="room-info" class="mb-2">
                        <strong>í˜„ì¬ ëŒ€í™”ë°© : </strong> <span id="current-room-name">ì—†ìŒ</span><br/>
                        <strong>ì°¸ì—¬ì : </strong> <span id="participant-list">-</span>
                    </div>
                    <div class="chat-log" id="chat-log"></div>
                    <div class="d-flex">
                        <input type="text" class="form-control me-2" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥">
                        <button class="btn btn-primary" onclick="sendMessage()">ì „ì†¡</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6>ë‚´ ì±„íŒ…ë°© ëª©ë¡</h6>
                    <div class="chat-room-list border rounded p-2 mb-2" id="chat-room-list"></div>
                    <button class="btn btn-warning btn-create-room" data-bs-toggle="modal" data-bs-target="#createRoomModal">â• ì±„íŒ…ë°© ìƒì„±</button>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="friend">
            <div class="row">
                <div class="col-md-6">
                    <h6>ğŸ” ì¹œêµ¬ ê²€ìƒ‰ ë° ìš”ì²­</h6>
                    <input type="text" id="search-name" class="form-control mb-2" placeholder="ì¹œêµ¬ ì´ë¦„ ì…ë ¥">
                    <button class="btn btn-outline-primary" onclick="sendFriendRequest()">ì¹œêµ¬ ìš”ì²­</button>
                </div>
                <div class="col-md-6">
                    <h6>ğŸ“© ì¹œêµ¬ ìš”ì²­ ì•Œë¦¼</h6>
                    <div class="border rounded p-2" id="friend-request-list" style="height: 150px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="mt-3">
                <h6>ğŸ‘¥ ë‚˜ì˜ ì¹œêµ¬ ëª©ë¡</h6>
                <input type="text" id="search-friend" class="form-control mb-2" placeholder="ì¹œêµ¬ ê²€ìƒ‰" oninput="searchFriend()">
                <div class="friend-list border rounded p-2" id="friend-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ -->
<div class="modal fade" id="createRoomModal" tabindex="-1" aria-labelledby="createRoomModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì±„íŒ…ë°© ìƒì„±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="room-name" class="form-control mb-2" placeholder="ì±„íŒ…ë°© ì´ë¦„">
                <input type="text" id="search-user" class="form-control mb-2" placeholder="ì¹œêµ¬ ê²€ìƒ‰" oninput="filterFriends()">
                <div id="friend-search-list"></div>
                <div class="selected-users" id="selected-users"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="createChatRoom()">ìƒì„±</button>
            </div>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem("token");
    const username = localStorage.getItem("username");
    let friendCache = [];
    let selectedUsers = [];
    let currentRoomId = null;

    let subscription = null;
    let sock = new SockJS("/ws-stomp");
    let stomp = Stomp.over(sock);

    stomp.connect({}, () => {
      console.log("WebSocket ì—°ê²° ì„±ê³µ");
    });

    function sendMessage() {
      const message = document.getElementById("chat-input").value;
      console.log("ì „ì†¡ ë©”ì‹œì§€:", message);
      console.log("currentRoomId:", currentRoomId);
      if (!currentRoomId || !message) return;
      stomp.send("/pub/chat/message", {}, JSON.stringify({
        chatRoomId: currentRoomId,
        sender: username,
        message: message
      }));
      document.getElementById("chat-input").value = "";
    }

    function enterRoom(roomId) {
      currentRoomId = roomId;
      document.getElementById("chat-log").innerHTML = "";

      if (subscription !== null) {
        subscription.unsubscribe();
      }

      subscription = stomp.subscribe("/sub/chat/room/" + roomId, (msg) => {
        const data = JSON.parse(msg.body);
        const log = document.getElementById("chat-log");
        const div = document.createElement("div");
        div.className = "mb-2";
        div.style.textAlign = (data.sender === username) ? "right" : "left";
        div.innerHTML = `<strong>${data.sender}</strong>: ${data.message}`;
        log.appendChild(div);

      });

      fetch(`/api/v1/chatroom/${roomId}/info`, {
          headers: { Authorization: `Bearer ${token}` }
        })
        .then(res => res.json())
        .then(data => {
          document.getElementById("current-room-name").innerText = data.roomName;
          const participantSpan = document.getElementById("participant-list");
          participantSpan.innerHTML = "";

          data.participants.forEach(name => {
            const isMe = name === username;
            const isOwner = name === data.ownerName;
            const span = document.createElement("span");
            span.className = "me-2";
            span.innerHTML = `${isOwner ? 'ğŸ‘‘ ' : 'ğŸ‘¤ '}<strong>${name}</strong>`;

            if (!isMe && data.ownerName === username) {
              const btn = document.createElement("button");
              btn.className = "btn btn-sm btn-danger ms-1 me-2";
              btn.innerText = "ê°•í‡´";
              btn.onclick = () => kickUser(roomId, name);
              span.appendChild(btn);
            }
            participantSpan.appendChild(span);
          });
        });


      fetch(`/api/v1/chatroom/${roomId}/messages`, {
        headers: { Authorization: `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        const log = document.getElementById("chat-log");
        log.innerHTML = "";
        data.forEach(chat => {
          const div = document.createElement("div");
          div.className = "mb-2";
          div.style.textAlign = (chat.sender === username) ? "right" : "left";
          div.innerHTML = `<strong>${chat.sender}</strong>: ${chat.message}`;
          log.appendChild(div);
        });
      });
    }

        function loadChatRooms() {
          fetch(`/api/v1/chatroom/show`, {
            headers: { 'Authorization': `Bearer ${token}` }
          })
          .then(res => res.json())
          .then(data => {
            const list = document.getElementById("chat-room-list");
            list.innerHTML = "";
            data.roomInfos.forEach(room => {
              const div = document.createElement("div");
              div.className = "d-flex justify-content-between align-items-center mb-2";
              div.innerHTML = `
                <span>${room.roomName}</span>
                <div>
                  <button class="btn btn-sm btn-outline-primary me-1" onclick="enterRoom(${room.chatRoomId})">ì…ì¥</button>
                  <button class="btn btn-sm btn-outline-danger" onclick="leaveRoom(${room.chatRoomId})">ë‚˜ê°€ê¸°</button>
                </div>
              `;
              list.appendChild(div);
            });
          });
        }

        function leaveRoom(roomId) {
          if (confirm("ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            fetch(`/api/v1/chatroom/leave?roomId=${roomId}`, {
              method: "DELETE",
              headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => {
              if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");
              return res.text(); // DELETEëŠ” ì‘ë‹µ ë³¸ë¬¸ì´ ì—†ì–´ë„ ë¨
            })
            .then(() => {
              alert("ì±„íŒ…ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.");
              loadChatRooms(); // âœ… ì„œë²„ ì‘ì—… ì™„ë£Œ í›„ ì‹¤í–‰
            })
            .catch(err => {
              alert("ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              console.error(err);
            });
          }
        }

        function sendFriendRequest() {
          const accepter = document.getElementById('search-name').value;
          fetch(`/api/v1/friend/request?accepter=${accepter}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
          })
          .then(res => res.json())
          .then(data => alert("ì¹œêµ¬ ìš”ì²­ ì™„ë£Œ: " + data.description.message));
        }

        function loadFriendRequests() {
          fetch(`/api/v1/friend/request/receivedlist`, {
            headers: { 'Authorization': `Bearer ${token}` }
          })
          .then(res => res.json())
          .then(data => {
            const listDiv = document.getElementById("friend-request-list");
            listDiv.innerHTML = "";
            data.receivedFriendList.forEach(item => {
              const container = document.createElement("div");
              container.className = "d-flex justify-content-between align-items-center mb-2";
              container.innerHTML = `
                <span>${item.requesterName}</span>
                <div>
                  <button class="btn btn-sm btn-success me-1" onclick="handleFriendAction(${item.requestId}, 'ACCEPTED')">ìˆ˜ë½</button>
                  <button class="btn btn-sm btn-danger" onclick="handleFriendAction(${item.requestId}, 'REJECTED')">ê±°ì ˆ</button>
                </div>
              `;
              listDiv.appendChild(container);
            });
          });
        }

        function handleFriendAction(id, status) {
          fetch(`/api/v1/friend/request/receivedlist/handle?requestId=${id}&status=${status}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
          })
          .then(res => res.json())
          .then(() => {
            alert("ì²˜ë¦¬ ì™„ë£Œ");
            loadFriendRequests();
            loadMyFriendList();
          });
        }

        function loadMyFriendList() {
          fetch("/api/v1/friend/list", {
            headers: { Authorization: `Bearer ${token}` }
          })
          .then(res => res.json())
          .then(data => {
            const container = document.getElementById("friend-list");
            friendCache = data.receivedFriendList;
            container.innerHTML = "";
            data.receivedFriendList.forEach(item => {
              const div = document.createElement("div");
              div.className = "d-flex justify-content-between align-items-center mb-2";
              div.innerHTML = `
                <span>${item.requesterName}</span>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteFriend(${item.requestId})">ì‚­ì œ</button>
              `;
              container.appendChild(div);
            });
          });
        }

        function deleteFriend(id) {
          fetch(`/api/v1/friend/list/delete?requestId=${id}`, {
            method: "DELETE",
            headers: { 'Authorization': `Bearer ${token}` }
          })
          .then(res => res.json())
          .then(() => {
            alert("ì‚­ì œ ì™„ë£Œ");
            loadMyFriendList();
          });
        }

        function searchFriend() {
          const keyword = document.getElementById("search-friend").value;
          fetch(`/api/v1/friend/list/search?keyword=${keyword}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          })
          .then(res => res.json())
          .then(data => {
            const friendList = document.getElementById("friend-list");
            friendList.innerHTML = "";
            data.receivedFriendList.forEach(f => {
              const div = document.createElement("div");
              div.className = "d-flex justify-content-between align-items-center mb-2";
              div.innerHTML = `
                <span>${f.requesterName}</span>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteFriend(${f.requestId})">ì‚­ì œ</button>
              `;
              friendList.appendChild(div);
            });
          });
        }

        function filterFriends() {
          const keyword = document.getElementById("search-user").value.toLowerCase();
          const container = document.getElementById("friend-search-list");
          container.innerHTML = "";
          const filtered = friendCache.filter(f => f.requesterName.toLowerCase().includes(keyword));
          filtered.forEach(friend => {
            const div = document.createElement("div");
            div.className = "d-flex justify-content-between align-items-center mb-2";
            div.innerHTML = `
              <span>${friend.requesterName}</span>
              <button class="btn btn-sm btn-outline-success" onclick="addUser('${friend.requesterName}')">ì¶”ê°€</button>
            `;
            container.appendChild(div);
          });
        }


        function kickUser(roomId, targetName) {
          if (confirm(`${targetName}ë‹˜ì„ ê°•í‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            fetch(`/api/v1/chatroom/kick`, {
              method: "POST",
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ roomId: roomId, targetName: targetName })
            })
            .then(res => res.text())
            .then(() => {
              alert(`${targetName} ê°•í‡´ ì™„ë£Œ`);
              enterRoom(roomId); // ê°•í‡´ í›„ ì°¸ì—¬ì ëª©ë¡ ê°±ì‹ 
            });
          }
        }

        function addUser(name) {
          if (!selectedUsers.includes(name)) {
            selectedUsers.push(name);
            updateSelectedUsers();
          }
        }

        function updateSelectedUsers() {
          const container = document.getElementById("selected-users");
          container.innerHTML = "<strong>ì„ íƒëœ ì°¸ì—¬ì:</strong> " + selectedUsers.join(", ");
        }

        function createChatRoom() {
          const roomName = document.getElementById("room-name").value;
          const requestData = {
            roomName: roomName,
            ownerName: username,
            userNames: [...selectedUsers, username]
          };

          fetch("/api/v1/chatroom/create", {
            method: "POST",
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(requestData)
          })
          .then(res => res.json())
          .then(() => {
            alert("ì±„íŒ…ë°© ìƒì„± ì™„ë£Œ!");
            selectedUsers = [];
            updateSelectedUsers();

            const modalElement = document.getElementById('createRoomModal');
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
              modalInstance.hide();
            }

            document.getElementById("selected-users").innerHTML = "";
            document.getElementById("room-name").value = "";

            loadChatRooms();
          });
        }

        window.onload = () => {
          loadFriendRequests();
          loadMyFriendList();
          loadChatRooms();
        };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
